Activate virtual environment:

source .venv/bin/activate
cd infrared
source etc/bash_completion.d/infrared

Copy topologies to Infrared:

cp hybrid_undercloud.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp hybrid_controller.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp 3_bridge_1_net.yml ~/infrared/plugins/virsh/vars/topology/network/.

Provision:

infrared virsh -v \
    --topology-nodes hybrid_undercloud:1,hybrid_controller:1 \
    -e override.controller.memory=28672 \
    -e override.undercloud.memory=28672 \
    -e override.controller.cpu=6 \
    -e override.undercloud.cpu=6 \
    --host-address 10.19.110.13 \
    --host-key ~/.ssh/id_rsa \
    --topology-network 3_bridges_1_net

    To clean (and only clean), just add "--cleanup yes"

Install Undercloud:

infrared tripleo-undercloud -v \
 --version=13 \
 --build=latest \
 --images-task=rpm \
 --config-file ~/ir-osp13/undercloud.conf

Introspect/Tag Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13/templates \
    --overcloud-script ~/ir-osp13/overcloud_deploy.sh \
     --build latest --introspect=yes --tagging=yes --deploy=no \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13/compute.json

CONTAINER STUFF BEFORE DEPLOY (perform as stack on undercloud):

sudo vi /usr/lib/python2.7/site-packages/tripleo_common/image/image_uploader.py

# no
#if DockerImageUploader._images_match(full_image, full_new_repo,
#                                     insecure_registries):
#    LOG.info('Skipping upload for image %s' % image_name)
#    return []

# Do cleanup after all the uploads so common layers don't get deleted
# repeatedly
# ^ no
#self.cleanup(local_images)

openstack overcloud container image prepare   --namespace rhosp13   --tag 2018-05-23.1 --prefix openstack- --pull-source docker-registry.engineering.redhat.com   --push-destination 192.0.2.1:8787   --images-file overcloud_containers.yaml
openstack overcloud container image upload --config-file overcloud_containers.yaml -v
openstack overcloud container image prepare   --namespace 192.0.2.1:8787/rhosp13   --tag 2018-05-23.1   --prefix openstack-  --env-file ~/templates/environments/docker_registry.yaml
echo "  DockerInsecureRegistryAddress: 192.0.2.1:8787" >>   ~/templates/environments/docker_registry.yaml

Deploy Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13/templates \
    --overcloud-script ~/ir-osp13/overcloud_deploy.sh \
     --build 20180523.1 --introspect=no --tagging=no --deploy=yes \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13/compute.json
